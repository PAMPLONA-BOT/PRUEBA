<!DOCTYPE html>
<html lang="es">
<head>
  <link href="manifest.json" rel="manifest"/>
  <meta name="theme-color" content="#00796b"/>
  <style>
  html, body {
    height: auto !important;
    min-height: 100% !important;
    overflow-y: auto !important;
  }
  </style>

  <style>
    .card pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-x: auto;
      font-size: 15px;
      color: #444;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
  </style>

<html lang="es"><head><link href="manifest.json" rel="manifest"/><meta content="#00796b" name="theme-color"/><script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(reg => console.log('SW registrado:', reg.scope))
    .catch(err => console.error('Error al registrar SW:', err));
}
</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Aplicaci√≥n de Navegaci√≥n</title>
<style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      flex-direction: column;
      color: #333;
    }

    .container {
      width: 90%;
      max-width: 600px;
      background-color: #fff;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 0 auto 60px auto;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .container:hover {
      transform: scale(1.02);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    .btn {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .btn:hover {
      background-color: #45a049;
      transform: translateY(-3px);
    }

    .btn-regresar {
      background-color: #FF6347;
      width: 50%;
      margin: 10px auto;
    }

    .btn-regresar:hover {
      background-color: #FF4500;
      transform: translateY(-3px);
    }

    h1 {
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }

    .logo {
      width: 120px;
      height: auto;
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    label {
      font-weight: bold;
      color: #444;
      margin-bottom: 6px;
      text-align: left;
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
      width: 100%;
    }

    .form-group select,
    .form-group input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      border: 2px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }

    #cicloSeccion {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    #cicloSeccion .form-group {
      flex: 1;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      gap: 5px;
      margin-bottom: 20px;
    }

    .btn-row .btn {
      width: 48%;
    }

    #vistaReporte h2 {
      font-size: 30px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2E8B57;
      text-align: center;
    }

    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      text-align: center;
      font-size: 14px;
      color: #888;
      background-color: #fff;
      padding: 10px 0;
      box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
    }

    .footer p {
      margin: 0;
    }

    #whatsappLink {
      text-decoration: none;
      text-align: center;
    }
  </style>
<style>
.card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    padding: 25px;
    margin: 20px auto;
    width: 90%;
    max-width: 800px;
}
.card h3 {
    font-size: 22px;
    margin-bottom: 12px;
    color: #2d7b5f;
}
.card p {
    font-size: 18px;
    color: #333;
    line-height: 1.5;
}
header {
    background: linear-gradient(to right, #00796b, #004d40);
    color: white;
    padding: 20px;
    font-size: 28px;
    font-weight: bold;
    text-align: center;
    border-bottom: 4px solid #004d40;
}
input[type="tel"] {
    border: 2px solid #4caf50;
    border-radius: 10px;
    padding: 15px;
    font-size: 20px;
    width: 80%;
    max-width: 500px;
    margin-bottom: 20px;
}
.numero-consultado {
    color: #00695c;
    font-size: 20px;
    margin: 15px 0;
    text-align: center;
}
button.button {
    transition: all 0.3s ease;
}
</style><style>
@media (max-width: 768px) {
    input[type="tel"] {
        width: 95% !important;
    }
    .card {
        width: 95% !important;
        padding: 15px !important;
    }
    .numero-consultado {
        font-size: 18px !important;
    }
}
form, .card {
    display: flex;
    flex-direction: column;
    align-items: center;
}
form button {
    margin: 10px 0;
}
</style><style>
button.button.green {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 18px;
    margin: 10px;
}
button.button.green:hover {
    background-color: #218838;
}
button.button.blue {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 18px;
    margin: 10px;
}
button.button.blue:hover {
    background-color: #0056b3;
}
button.btn-clear {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 18px;
    margin: 10px;
}
button.btn-clear:hover {
    background-color: #c82333;
}
</style><style>
body {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 30px 10px;
    background-color: #f4f6f8;
    box-sizing: border-box;
}

#interfazSecundaria > div {
    width: 100%;
    max-width: 800px;
    margin: auto;
}
</style><style>
#resultados .card {
    text-align: left;
    padding: 20px;
    word-wrap: break-word;
    box-sizing: border-box;
    margin: 20px auto;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    width: 100%;
    max-width: 800px;
}
#resultados .card p {
    font-size: 16px;
    line-height: 1.6;
    color: #333;
    margin: 8px 0;
}

/* --- ESTILOS PARA EL HISTORIAL DE REPORTES --- */
#reporteHistorico {
  text-align: left;
  margin-top: 25px;
  border-top: 1px solid #eee;
  padding-top: 15px;
}
#reporteHistorico h3 {
  text-align: center;
  color: #333;
}
#listaHistorico {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
}
.item-historico {
  background-color: #f9f9f9;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 8px;
}
.item-historico-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.status-synced {
  color: #28a745;
  font-weight: bold;
}
.status-pending_sync {
  color: #ffc107;
  font-weight: bold;
}
.item-historico details {
  margin-top: 8px;
}
#forceSyncBtn {
  background-color: #ff9800;
  width: 100%;
}
</style>
<style>
.card pre {
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-x: auto;
  font-size: 15px;
  color: #444;
  background-color: #f9f9f9;
  padding: 10px;
  border-radius: 6px;
  width: 100%;
  box-sizing: border-box;
}
</style>
<!-- INICIO: ESTILOS MODIFICADOS -->
<style>
  #vistaReporte .btn-row {
    margin-bottom: 10px;
    gap: 10px;
  }
  #vistaReporte .btn-row .btn {
    padding: 10px;
    font-size: 14px;
    margin: 0;
  }
  #reporteHistorico {
    border-top: 2px solid #00796b;
    margin-top: 30px;
    padding-top: 20px;
  }
  #reporteHistorico h3 {
    color: #00796b;
    font-weight: bold;
    font-size: 20px;
  }
  
  .item-historico-actions {
      display: flex;
      align-items: center;
      gap: 8px;
  }
  .btn-delete-report {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
      line-height: 28px;
      text-align: center;
      transition: background-color 0.2s ease;
  }
  .btn-delete-report:hover {
      background-color: #c82333;
  }
</style>
<!-- FIN: ESTILOS MODIFICADOS -->
</style><script>
document.addEventListener("DOMContentLoaded", function () {
  const app = document.getElementById('interfazPrincipal');
  const secundaria = document.getElementById('interfazSecundaria');
  if (app) app.style.display = 'none';
  if (secundaria) secundaria.style.display = 'none';

  const esIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const esAndroid = /android/i.test(navigator.userAgent);

  const mensaje = document.getElementById("mensajeInstruccion");
  if (esIOS) {
    mensaje.innerHTML = "<p>üì± En iPhone, toca el bot√≥n <strong>Compartir</strong> y elige <strong>'Agregar a pantalla de inicio'</strong>.</p>";
  } else if (esAndroid) {
    mensaje.innerHTML = "<p>üì± En Android, abre el men√∫ del navegador y selecciona <strong>'Agregar a pantalla principal'</strong>.</p>";
  } else {
    mensaje.innerHTML = "<p>Esta aplicaci√≥n solo funciona correctamente cuando es instalada en la pantalla de inicio.</p>";
  }

  verificarInstalacion();
});

function verificarInstalacion() {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isStandalone) {
    document.getElementById('pantallaInicio').style.display = 'none';
    const app = document.getElementById('interfazPrincipal');
    if (app) app.style.display = 'block';
  }
}
</script></head><body>
<div id="loginContainer" style="text-align:center;padding:40px;font-family:sans-serif;">
<h2>üîê Acceso a la App Regional Pamplona</h2>
<p>Ingrese su clave para continuar:</p>
<input id="claveUsuario" placeholder="Clave de acceso" style="padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc; width:80%; max-width:300px;" type="password"/>
<br/><br/>
<button onclick="verificarClave()" style="padding:10px 20px; font-size:16px; border-radius:8px; background-color:#00796b; color:white; border:none;">Ingresar</button>
<p id="mensajeLogin" style="color:red; margin-top:20px;"></p>
</div>
<div id="pantallaInicio" style="text-align:center;padding:40px;font-family:sans-serif;">
<h2>üöÄ ¬°Bienvenido a la App Regional Pamplona!</h2>
<p>Para usar esta aplicaci√≥n correctamente, debes instalarla en la pantalla de inicio.</p>
<div id="mensajeInstruccion" style="margin:20px 0;"></div>
<button onclick="verificarInstalacion()" style="padding:10px 20px; font-size:16px; border-radius:8px; background-color:#00796b; color:white; border:none;">Ya la instal√©</button>
</div>
<div id="interfazPrincipal" style="display: block;"><!-- Vista principal --><div class="container" id="inicio">
<img alt="Logo de la p√°gina" class="logo" src="Logo.png"/>
<h1>REGIONAL PAMPLONA</h1>
<button class="btn" onclick="mostrarFormulario()">REPORTE DIARIO</button>
<button class="btn" onclick="mostrarInterfazSecundaria()">VALIDADOR USUARIOS</button>
<button class="btn" onclick="irAUrl('https://script.google.com/macros/s/AKfycbw2z6rVlBqlPU0drL9Rus_p_ORjVfl8iGQBL-gupoDio4Fq3ElbrqUILguiAtLYWpJZfg/exec', 'revisionEjecutada')">REVISIONES EJECUTADAS</button>
<button class="btn" onclick="irAUrl('https://pamplona-bot.github.io/FIRMAS/', 'FIRMAS')">FIRMA FORMACIONES</button>
<button class="btn" onclick="irAUrl('https://script.google.com/macros/s/AKfycbw-YQTef8VFk4KPc7S8iPnmMXxzaXLegyH8tLk-TqxNwROMi-mRqiUh8LwhQ2J1RbXFAA/exec', 'pendienteDescargas')">CONSULTA DE RUTA Y KML</button>
<button class="btn" onclick="irAUrl('https://pamplona-bot.github.io/PAMPLONA_ENRUTES/', 'enrutes')">ENRUTES</button>
</div><!-- Vista de formulario --><div class="container hidden" id="vistaReporte">
<h2>Reporte Diario</h2>
<div class="form-group">
<label for="operario">Operario:</label>
<select id="operario"></select>
</div>
<div id="cicloSeccion">
<div class="form-group">
<label for="ciclo">Ciclo:</label>
<select id="ciclo"></select>
</div>
<div class="form-group">
<label for="seccion">Secci√≥n:</label>
<select id="seccion"></select>
</div>
</div>
<div class="form-group">
<label for="via">üìù Seleccione tipo de campo:</label>
<select onchange="document.querySelector('label[for=via]').textContent = this.value + ':';">
<option value="üõ£Ô∏è V√≠a">üõ£Ô∏è V√≠a</option>
<option value="üë®üèª Primer usuario">üë®üèª Primer usuario</option>
<option value="üèô En">üèô En</option>
</select>
<input id="via" placeholder="Ingrese dato segun reporte, la v√≠a de traslado, primer usuario o lugar de finalizacion" type="text"/>
</div>
<div class="btn-row">
<button class="btn" onclick="enviarReporte('salida')">TRASLADO SALIDA</button>
<button class="btn" onclick="enviarReporte('regreso')">TRASLADO REGRESO</button>
</div>
<div class="btn-row">
<button class="btn" onclick="enviarReporte('inicio')">INICIO DE LABOR</button>
<button class="btn" onclick="enviarReporte('fin')">FIN DE LABOR</button>
</div>
<div class="btn-row">
<button class="btn" style="background-color: #f0ad4e;" onclick="enviarReporteEspecial('txt')">TXT</button>
<button class="btn" style="background-color: #d9534f;" onclick="enviarReporteEspecial('incapacidad')">INCAPACIDAD</button>
</div>
<button class="btn btn-regresar" onclick="regresarAPrincipal()">INICIO</button>
<a class="btn hidden" href="#" id="whatsappLink" target="_blank">ENVIAR AL GRUPO DE WHATSAPP</a>
<button class="btn" onclick="copiarReporte()">üìã PEGAR REPORTE</button>

<div id="reporteHistorico">
    <h3>Historial de Reportes Diarios</h3>
    <div id="listaHistorico">No hay reportes guardados.</div>
</div>
<button class="btn" id="forceSyncBtn" onclick="forceSyncPending()" style="display: none; margin-top: 15px;">‚ö†Ô∏è FORZAR ENV√çO DE PENDIENTES</button>

</div><div class="footer">
<p>Versi√≥n: 001</p>
<p id="fechaHora"></p>
</div>
<!-- ================================================================= -->
<!-- ===================== INICIO SCRIPT PRINCIPAL =================== -->
<!-- ================================================================= -->
<script>
  // --- CONSTANTES Y CONFIGURACI√ìN ---
  const REPORTS_STORAGE_KEY = 'daily_reports_pamplona';
  const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxhL9z2Ja7I0QFHn3nReY2NVR1AIn1_SJtei9FIifBLI7vy8PWz0cv_6Dr1Y61z9blcJA/exec';
  const DAILY_REPORT_CACHE_KEY = 'daily_report_cache_pamplona';

  window.onload = function () {
    mostrarFechaHora();
    Promise.all([
      fetch('operarios.json').then(response => response.json()),
      fetch('ciclos.json').then(response => response.json()),
      fetch('secciones.json').then(response => response.json())
    ])
    .then(([operarios, ciclos, seccionesPorCiclo]) => {
      llenarSelect("operario", operarios);
      llenarSelect("ciclo", ciclos);
      document.getElementById("ciclo").addEventListener("change", function () {
        const cicloSeleccionado = this.value;
        const secciones = seccionesPorCiclo[cicloSeleccionado] || [];
        llenarSelect("seccion", secciones);
      });
    })
    .catch(error => {
      console.error("Error al cargar los datos de configuraci√≥n:", error);
      alert("No se pudieron cargar los datos para el reporte diario. Por favor, revise la conexi√≥n y recargue la p√°gina.");
    });
  };
  
  function saveDailyReportCache() {
    const operario = document.getElementById("operario").value;
    const ciclo = document.getElementById("ciclo").value;
    const seccion = document.getElementById("seccion").value;
    if (operario && ciclo && seccion) {
      const today = new Date().toISOString().slice(0, 10);
      const cacheData = { date: today, operario, ciclo, seccion };
      localStorage.setItem(DAILY_REPORT_CACHE_KEY, JSON.stringify(cacheData));
    }
  }

  function loadDailyReportCache() {
    const cachedDataString = localStorage.getItem(DAILY_REPORT_CACHE_KEY);
    if (!cachedDataString) return;
    const today = new Date().toISOString().slice(0, 10);
    const cachedData = JSON.parse(cachedDataString);
    if (cachedData.date === today) {
      document.getElementById('operario').value = cachedData.operario;
      const cicloSelect = document.getElementById('ciclo');
      cicloSelect.value = cachedData.ciclo;
      cicloSelect.dispatchEvent(new Event('change'));
      document.getElementById('seccion').value = cachedData.seccion;
    } else {
      localStorage.removeItem(DAILY_REPORT_CACHE_KEY);
    }
  }

  function getReports() {
    return JSON.parse(localStorage.getItem(REPORTS_STORAGE_KEY)) || [];
  }

  function saveReports(reports) {
    localStorage.setItem(REPORTS_STORAGE_KEY, JSON.stringify(reports));
    renderReportHistory();
    updateSyncButtonVisibility();
  }

  function llenarSelect(id, valores) {
    const select = document.getElementById(id);
    select.innerHTML = '<option value="">Seleccione</option>';
    valores.forEach(valor => {
      select.add(new Option(valor, valor));
    });
  }

  function irAUrl(url) {
    window.location.href = url;
  }

  function mostrarFechaHora() {
    const now = new Date();
    document.getElementById('fechaHora').innerHTML = `Fecha y Hora: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
  }

  function mostrarFormulario() {
    document.getElementById('inicio').classList.add('hidden');
    document.getElementById('vistaReporte').classList.remove('hidden');
    loadDailyReportCache();
    renderReportHistory();
    updateSyncButtonVisibility();
  }

  function regresarAPrincipal() {
    document.getElementById('vistaReporte').classList.add('hidden');
    document.getElementById('inicio').classList.remove('hidden');
  }

  async function guardarEstadoReporte(tipo, operario, ciclo, seccion) {
    const reports = getReports();
    const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
    const reportId = `${new Date().toISOString().slice(0, 10)}-${operario}`;
    const hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
    let report = reports.find(r => r.id === reportId);
    if (!report) {
      if (tipo !== 'salida') {
        alert('Debe iniciar con "TRASLADO SALIDA" para crear el reporte del d√≠a.');
        return false;
      }
      report = { id: reportId, operario, fechaSalida: today, status: 'in_progress' };
      reports.push(report);
    }
    switch(tipo) {
      case 'salida': report.ciclo = ciclo; report.seccion = seccion; report.horaSalida = hora; break;
      case 'inicio': report.horaInicio = hora; break;
      case 'regreso': report.horaRegreso = hora; break;
      case 'fin': report.horaFin = hora; report.status = 'pending_sync'; break;
    }
    saveReports(reports);
    if (tipo === 'fin') await submitReportToGoogleSheets(report);
    return true;
  }
  
  async function submitReportToGoogleSheets(report) {
    const formData = new FormData();
    Object.keys(report).forEach(key => formData.append(key, report[key] || ''));
    try {
      const response = await fetch(GOOGLE_SHEET_URL, { method: 'POST', body: formData });
      if (!response.ok) throw new Error(`Respuesta del servidor no OK: ${response.statusText}`);
      const result = await response.json();
      if (result.status === 'success') {
        const reports = getReports();
        const reportIndex = reports.findIndex(r => r.id === report.id);
        if (reportIndex > -1) {
          reports[reportIndex].status = 'synced';
          saveReports(reports);
          alert('Reporte del d√≠a finalizado y enviado correctamente.');
        }
      } else {
        throw new Error(result.message || 'Error desconocido del script de Google.');
      }
    } catch (error) {
      console.error('Error al enviar el reporte a Google Sheets:', error);
      alert('No se pudo enviar el reporte. Qued√≥ guardado como pendiente.');
    }
  }

  async function forceSyncPending() {
    const pendingReports = getReports().filter(r => r.status === 'pending_sync');
    if (pendingReports.length === 0) return alert("No hay reportes pendientes.");
    alert(`Iniciando env√≠o de ${pendingReports.length} reporte(s) pendiente(s).`);
    let successCount = 0;
    for (const report of pendingReports) {
      await submitReportToGoogleSheets(report);
      if (getReports().find(r => r.id === report.id)?.status === 'synced') {
        successCount++;
      }
    }
    alert(`${successCount} de ${pendingReports.length} reporte(s) enviados.`);
    renderReportHistory();
    updateSyncButtonVisibility();
  }

  async function enviarReporteBase(generarMensaje, guardarDatos) {
    const operario = document.getElementById("operario").value;
    const ciclo = document.getElementById("ciclo").value;
    const seccion = document.getElementById("seccion").value;
    const via = document.getElementById("via").value.trim();

    if (!operario) return alert("Por favor seleccione un Operario.");
    if (guardarDatos) {
        if ((guardarDatos.tipo === "salida" || guardarDatos.tipo === "regreso") && (!ciclo || !seccion || !via)) {
            return alert("Por favor complete Operario, Ciclo, Secci√≥n y V√≠a.");
        }
        if ((guardarDatos.tipo === "inicio" || guardarDatos.tipo === "fin") && !via) {
            return alert("Por favor complete Operario y el campo correspondiente.");
        }
    }
    
    saveDailyReportCache();
    if (!navigator.geolocation) return alert("Geolocalizaci√≥n no disponible.");

    navigator.geolocation.getCurrentPosition(async pos => {
      if (guardarDatos && !(await guardarEstadoReporte(guardarDatos.tipo, operario, ciclo, seccion))) {
        return; // Detener si guardarEstadoReporte fall√≥
      }
      
      const mensaje = generarMensaje(pos, { operario, ciclo, seccion, via });
      ultimoMensajeGenerado = mensaje;
      window.open("https://wa.me/?text=" + encodeURIComponent(mensaje), "_blank");
      document.getElementById("via").value = "";

    }, () => alert("Favor activar GPS y DATOS para enviar el reporte."));
  }
  
  function enviarReporte(tipo) {
    const generarMensaje = (pos, data) => {
        const mapaCod = {"0":"F","1":"G","2":"C","3":"I","4":"V","5":"A","6":"B","7":"H","8":"Z","9":"J",".":"K",",":"L","-":"M"};
        const codificarCoord = c => [...c].map(l => mapaCod[l] || '').join('');
        const codificado = codificarCoord(pos.coords.latitude.toFixed(7) + "," + pos.coords.longitude.toFixed(7));
        const hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const titulos = { salida: "üèçüîÄ Traslado de salida", regreso: "üèç‚Ü©Ô∏è Traslado de regreso", inicio: "üßæ Inicio de labor", fin: "ü™´ Fin de labor" };
        let mensaje = `${titulos[tipo]}\nüóì Fecha: ${new Date().toLocaleDateString()} ${codificado.slice(0, Math.floor(codificado.length/2))}\n‚è∞ Hora: ${hora} ${codificado.slice(Math.floor(codificado.length/2))}\nüë∑‚Äç‚ôÇÔ∏è Operario: ${data.operario}`;
        if (tipo === "salida" || tipo === "regreso") {
            mensaje += `\nüîÅ Ciclo: ${data.ciclo}\nüìç Secci√≥n: ${data.seccion}\nüõ£Ô∏è V√≠a: ${data.via}`;
        } else {
            mensaje += `\n${document.querySelector("label[for=via]").textContent.replace(":", "")}: ${data.via}`;
        }
        return mensaje;
    };
    enviarReporteBase(generarMensaje, { tipo });
  }

  function enviarReporteEspecial(tipo) {
     const generarMensaje = (pos, data) => {
        const mapaCod = {"0":"F","1":"G","2":"C","3":"I","4":"V","5":"A","6":"B","7":"H","8":"Z","9":"J",".":"K",",":"L","-":"M"};
        const codificarCoord = c => [...c].map(l => mapaCod[l] || '').join('');
        const codificado = codificarCoord(pos.coords.latitude.toFixed(7) + "," + pos.coords.longitude.toFixed(7));
        const hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const reporteTipo = tipo.toUpperCase();
        return `üö® REPORTE ESPECIAL: ${reporteTipo}\nüóì Fecha: ${new Date().toLocaleDateString()} ${codificado.slice(0, Math.floor(codificado.length/2))}\n‚è∞ Hora: ${hora} ${codificado.slice(Math.floor(codificado.length/2))}\nüë∑‚Äç‚ôÇÔ∏è Operario: ${data.operario}\nüìù Motivo: ${reporteTipo}\nüîÅ Ciclo: ${reporteTipo}\nüìç Secci√≥n: 00`;
    };
    enviarReporteBase(generarMensaje);
    // Para reportes especiales, tambi√©n se env√≠a a Sheets inmediatamente.
    const operario = document.getElementById("operario").value;
    if (operario) {
        const report = {
            id: `${new Date().toISOString().slice(0, 10)}-${operario}`, operario,
            fechaSalida: new Date().toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }),
            ciclo: tipo.toUpperCase(), seccion: '00', horaSalida: '00:00', horaInicio: '00:00', horaRegreso: '00:00', horaFin: '00:00',
            status: 'pending_sync'
        };
        const reports = getReports();
        const existingIndex = reports.findIndex(r => r.id === report.id);
        if (existingIndex > -1) reports[existingIndex] = report; else reports.push(report);
        saveReports(reports);
        submitReportToGoogleSheets(report);
    }
  }

  let ultimoMensajeGenerado = "";

  function copiarReporte() {
    if (!ultimoMensajeGenerado) return alert("No hay reporte para copiar.");
    navigator.clipboard.writeText(ultimoMensajeGenerado)
      .then(() => alert("Reporte copiado al portapapeles."))
      .catch(() => alert("No se pudo copiar el texto."));
  }
  
  function solicitarBorradoReporte(reportId) {
    if (confirm("¬øEst√° seguro de que desea eliminar este reporte?")) {
        saveReports(getReports().filter(r => r.id !== reportId));
    }
  }

  // (MODIFICADO) Renderizado del historial con orden por fecha
  function renderReportHistory() {
      const reports = getReports();
      const listaDiv = document.getElementById('listaHistorico');
      
      // Ordenar por fecha descendente (m√°s nuevo primero)
      reports.sort((a, b) => new Date(b.id.slice(0, 10)) - new Date(a.id.slice(0, 10)));

      if(reports.length === 0){
          listaDiv.innerHTML = "<p>No hay reportes guardados.</p>";
          return;
      }
      
      listaDiv.innerHTML = reports.map(report => {
          let deleteButtonHtml = report.status !== 'synced' 
              ? `<button class="btn-delete-report" onclick="solicitarBorradoReporte('${report.id}')">üóëÔ∏è</button>`
              : '';
          
          return `
          <div class="item-historico">
              <div class="item-historico-header">
                  <span><strong>${report.fechaSalida}</strong> - ${report.operario}</span>
                  <div class="item-historico-actions">
                    <span class="status-${report.status}">${report.status === 'synced' ? 'Enviado' : (report.status === 'pending_sync' ? 'Pendiente' : 'En Progreso')}</span>
                    ${deleteButtonHtml}
                  </div>
              </div>
              <details>
                  <summary>Ver detalles</summary>
                  <p><strong>Ciclo-Secci√≥n:</strong> ${report.ciclo || 'N/A'} - ${report.seccion || 'N/A'}</p>
                  <p><strong>Salida:</strong> ${report.horaSalida || '--:--'} | <strong>Inicio:</strong> ${report.horaInicio || '--:--'} | <strong>Regreso:</strong> ${report.horaRegreso || '--:--'} | <strong>Fin:</strong> ${report.horaFin || '--:--'}</p>
              </details>
          </div>
      `}).join('');
  }

  function updateSyncButtonVisibility() {
      document.getElementById('forceSyncBtn').style.display = getReports().some(r => r.status === 'pending_sync') ? 'block' : 'none';
  }
</script>
<!-- ================================================================= -->
<!-- ====================== FIN SCRIPT PRINCIPAL ===================== -->
<!-- ================================================================= -->
<button onclick="actualizarApp()" style="display: block; margin: 20px auto; padding: 10px 20px; font-size: 16px; background-color: #ffc107; color: #000; border: none; border-radius: 8px; cursor: pointer;">üîÅ Actualizar App</button>
<script>
function actualizarApp() {
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      for (let reg of registrations) {
        reg.unregister().then(() => {
          caches.keys().then(names => {
            for (let name of names) caches.delete(name);
          });
          location.reload(true);
        });
      }
    });
  } else {
    location.reload(true);
  }
}
</script>
</div>
<div id="interfazSecundaria" style="display: none;">
    <button onclick="mostrarInterfazPrincipal()" style="margin: 20px auto; display: block; background-color: tomato; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">‚¨Ö Volver al Inicio</button>
    <button onclick="cargarDatosJSON()" style="margin-left:10px; padding:10px 15px; border-radius:8px; background:#0a7d5f; color:white; border:none;">üìÇ Cargar Datos</button>
    <div id="barraCarga" style="margin-top:10px; display:none;">
        <progress id="progresoCarga" max="100" style="width:80%; height:20px;" value="0"></progress>
        <p id="estadoCarga" style="font-size:14px;"></p>
    </div>
    <div style="max-width: 800px; margin: auto; padding: 20px; text-align: center;">
        <header>Consulta de Datos</header>
        <form onsubmit="event.preventDefault(); buscarDatos();">
            <input id="numeroUsuario" placeholder="Ingrese n√∫mero de usuario o llave" type="tel"/>
            <button class="button green" onclick="buscarDatos()" style="display:none;" type="button">Cliente</button>
            <button class="button blue" onclick="buscarDatosConLlave()" style="display:none;" type="button">Medidor</button>
        </form>
        <div class="numero-consultado" id="numeroConsultado"></div>
        <div id="resultados"></div>
        <button class="btn-clear button" onclick="limpiarConsulta()" style="display:none;">Limpiar Consulta</button>
    </div>
<script>
// Validaci√≥n y limpieza OBLIGATORIA de cache al cambiar de mes
(function() {
    async function limpiarCacheCompleto() {
        try {
            const overlay = document.createElement('div');
            Object.assign(overlay.style, { position: 'fixed', top: '0', left: '0', width: '100%', height: '100%', backgroundColor: 'rgba(0,0,0,0.95)', zIndex: '10000', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', color: 'white', padding: '20px', textAlign: 'center' });
            overlay.innerHTML = `<h2 style="color: #4CAF50;">Actualizaci√≥n Requerida</h2><div style="width: 80%; max-width: 300px; height: 20px; background: #333; border-radius: 10px; margin: 10px 0;"><div id="cleaner-progress-bar" style="width: 0%; height: 100%; background: #4CAF50; border-radius: 10px; transition: width 0.6s;"></div></div><p id="cleaner-progress-text" style="color: #aaa;">Preparando...</p>`;
            document.body.appendChild(overlay);
            
            const actualizarProgreso = (mensaje, porcentaje) => {
                document.getElementById('cleaner-progress-bar').style.width = `${porcentaje}%`;
                document.getElementById('cleaner-progress-text').textContent = mensaje;
            };
            
            actualizarProgreso('Eliminando datos...', 20);
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                await Promise.all(registrations.map(reg => reg.unregister()));
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
            }
            actualizarProgreso('Limpiando configuraciones...', 40);
            localStorage.clear(); sessionStorage.clear();
            actualizarProgreso('Actualizando bases de datos...', 60);
            if (window.indexedDB && window.indexedDB.databases) {
                const dbs = await window.indexedDB.databases();
                await Promise.all(dbs.map(db => new Promise((resolve, reject) => {
                    const req = window.indexedDB.deleteDatabase(db.name);
                    req.onsuccess = resolve; req.onerror = reject;
                })));
            }
            actualizarProgreso('Finalizando...', 80);
            const fecha = new Date();
            localStorage.setItem('ultimoMesUsado', fecha.getMonth() + 1);
            localStorage.setItem('ultimoAnioUsado', fecha.getFullYear());
            actualizarProgreso('¬°Completado!', 100);
            setTimeout(() => window.location.reload(true), 1500);
        } catch (error) {
            console.error('Error en limpieza completa:', error);
            document.body.innerHTML = `<div style="color:white;text-align:center;padding:50px;"><h2>Error en la actualizaci√≥n</h2><p>Recargue la p√°gina (Ctrl+F5) para reintentar.</p></div>`;
        }
    }
    document.addEventListener("DOMContentLoaded", function() {
        const fecha = new Date();
        const mesActual = fecha.getMonth() + 1;
        const anioActual = fecha.getFullYear();
        const ultimoMesUsado = localStorage.getItem('ultimoMesUsado');
        const ultimoAnioUsado = localStorage.getItem('ultimoAnioUsado');
        
        if (!ultimoMesUsado || (ultimoAnioUsado < anioActual) || (ultimoAnioUsado == anioActual && ultimoMesUsado < mesActual)) {
            const overlay = document.createElement('div');
            Object.assign(overlay.style, { position: 'fixed', top: '0', left: '0', width: '100%', height: '100%', backgroundColor: 'rgba(0,0,0,0.95)', zIndex: '10000', display: 'flex', justifyContent: 'center', alignItems: 'center', color: 'white', padding: '20px', textAlign: 'center' });
            overlay.innerHTML = `<div style="background: #222; padding: 30px; border-radius: 10px; max-width: 500px;"><h2>Actualizaci√≥n Requerida</h2><p>Actualizando la aplicaci√≥n para el nuevo mes.</p><div id="countdown" style="font-size: 18px; margin: 20px 0;">Iniciando en 5s...</div></div>`;
            document.body.appendChild(overlay);
            let s = 5;
            const i = setInterval(() => {
                s--;
                document.getElementById('countdown').textContent = `Iniciando en ${s}s...`;
                if (s <= 0) { clearInterval(i); limpiarCacheCompleto(); }
            }, 1000);
        } else {
            localStorage.setItem('ultimoMesUsado', mesActual);
            localStorage.setItem('ultimoAnioUsado', anioActual);
        }
    });
})();
</script>
</div>

<script>
function mostrarInterfazSecundaria() { document.getElementById('interfazPrincipal').style.display = 'none'; document.getElementById('interfazSecundaria').style.display = 'block'; }
function mostrarInterfazPrincipal() { document.getElementById('interfazSecundaria').style.display = 'none'; document.getElementById('interfazPrincipal').style.display = 'block'; }

document.addEventListener("DOMContentLoaded", function () {
  const mesActual = new Date().getMonth() + 1;
  const anioActual = new Date().getFullYear();
  const claveGuardada = localStorage.getItem("acceso_autorizado");
  if (claveGuardada === `${mesActual}-${anioActual}`) {
    iniciarFlujoApp();
  } else {
    document.getElementById("loginContainer").style.display = "block";
    document.getElementById("pantallaInicio").style.display = "none";
    document.getElementById("interfazPrincipal").style.display = "none";
    document.getElementById("interfazSecundaria").style.display = "none";
  }
});

function verificarClave() {
  const clave = document.getElementById("claveUsuario").value.trim();
  if (!clave) return document.getElementById("mensajeLogin").textContent = "Ingrese una clave.";
  fetch(`https://script.google.com/macros/s/AKfycbxI762q67BzAK-IkJS3Nh8y6qrSCu7YfxPMEvngmO0H8y0sUx89Rj2hjCOe4P22VeNwSA/exec?clave=${clave}`)
    .then(res => res.text())
    .then(respuesta => {
      if (respuesta.trim() === "OK") {
        const mesActual = new Date().getMonth() + 1;
        const anioActual = new Date().getFullYear();
        localStorage.setItem("acceso_autorizado", `${mesActual}-${anioActual}`);
        iniciarFlujoApp();
      } else {
        document.getElementById("mensajeLogin").textContent = "Clave incorrecta.";
      }
    })
    .catch(() => document.getElementById("mensajeLogin").textContent = "Error al validar. Verifique su conexi√≥n.");
}

function iniciarFlujoApp() {
  document.getElementById("loginContainer").style.display = "none";
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isStandalone) {
    document.getElementById("pantallaInicio").style.display = "none";
    document.getElementById("interfazPrincipal").style.display = "block";
  } else {
    document.getElementById("pantallaInicio").style.display = "block";
  }
}
</script>

<script>
let dataUsuarios = [], dataLectura = [], dataRevisiones = [];
let datosCargados = false;

async function cargarDatosJSON() {
  if (datosCargados) return alert("Los datos ya fueron cargados.");
  const barraCarga = document.getElementById("barraCarga");
  const progresoCarga = document.getElementById("progresoCarga");
  const estadoCarga = document.getElementById("estadoCarga");
  barraCarga.style.display = "block";
  
  const actualizarProgreso = (texto, valor) => {
      estadoCarga.textContent = texto;
      progresoCarga.value = valor;
  };
  
  try {
      actualizarProgreso("üìÇ Cargando usuarios...", 20);
      dataUsuarios = await (await fetch("https://pamplona-bot.github.io/pamplona-app-pwa/usuarios.json")).json();
      actualizarProgreso("üìò Cargando lecturas...", 50);
      dataLectura = await (await fetch("https://pamplona-bot.github.io/pamplona-app-pwa/lecturas.json")).json();
      actualizarProgreso("üìô Cargando revisiones...", 80);
      dataRevisiones = await (await fetch("https://pamplona-bot.github.io/pamplona-app-pwa/revisiones.json")).json();
      
      actualizarProgreso("‚úÖ ¬°Datos cargados!", 100);
      datosCargados = true;
      document.querySelector('button[onclick="buscarDatos()"]').style.display = "inline-block";
      document.querySelector('button[onclick="buscarDatosConLlave()"]').style.display = "inline-block";
      document.querySelector('button[onclick="limpiarConsulta()"]').style.display = "inline-block";
  } catch(err) {
      actualizarProgreso("‚ùå Error al cargar. Revise la conexi√≥n.", 0);
      console.error("Error al cargar JSON", err);
  }
}

function renderCard(title, content) {
    return `<div class="card"><h3>${title}</h3>${content}</div>`;
}

function buscarDatos() {
  if (!datosCargados) return alert("Primero cargue los datos.");
  const numero = document.getElementById("numeroUsuario").value.trim();
  document.getElementById("numeroConsultado").innerHTML = `<strong>CLIENTE:</strong> ${numero}`;
  let html = "";
  const usuario = dataUsuarios.find(row => row[0] === numero);
  const lectura = dataLectura.find(row => row[0] === numero);
  const revision = dataRevisiones.find(row => row[0] === numero);
  if (usuario) html += renderCard("Informaci√≥n del Usuario", `<p><strong>Ciclo:</strong> ${usuario[1]}</p><p><strong>Medidor:</strong> ${usuario[2]}</p><p><strong>Nombre:</strong> ${usuario[3]}</p><p><strong>Direcci√≥n:</strong> ${usuario[4]}</p><p><strong>Tel√©fono:</strong> ${usuario[5]}</p><p><strong>GPS:</strong> <a href="${usuario[6]}" target="_blank">Ver mapa</a></p>`);
  if (lectura) html += renderCard("Lecturas", `<p><strong>Dato 1:</strong> ${lectura[1]}</p><p><strong>Dato 2:</strong> ${lectura[2]}</p><p><strong>Dato 3:</strong> ${lectura[3]}</p>`);
  if (revision) html += renderCard("Revisiones", `<pre>${revision[1]}</pre>`);
  document.getElementById("resultados").innerHTML = html || renderCard("Sin resultados", "<p>No se encontr√≥ informaci√≥n para el n√∫mero ingresado.</p>");
}

function buscarDatosConLlave() {
  if (!datosCargados) return alert("Primero cargue los datos.");
  const llave = document.getElementById("numeroUsuario").value.trim();
  document.getElementById("numeroConsultado").innerHTML = `<strong>MEDIDOR:</strong> ${llave}`;
  let html = "";
  const usuario = dataUsuarios.find(row => row[7] === llave);
  if(usuario) {
      const lectura = dataLectura.find(row => row[0] === usuario[0]);
      const revision = dataRevisiones.find(rev => rev[0] === usuario[0]);
      html += renderCard("Informaci√≥n del Usuario", `<p><strong>Cliente:</strong> ${usuario[0]}</p><p><strong>Ciclo:</strong> ${usuario[1]}</p><p><strong>Medidor:</strong> ${usuario[2]}</p><p><strong>Nombre:</strong> ${usuario[3]}</p><p><strong>Direcci√≥n:</strong> ${usuario[4]}</p><p><strong>Tel√©fono:</strong> ${usuario[5]}</p><p><strong>GPS:</strong> <a href="${usuario[6]}" target="_blank">Ver mapa</a></p>`);
      if (lectura) html += renderCard("Lecturas", `<p><strong>Dato 1:</strong> ${lectura[1]}</p><p><strong>Dato 2:</strong> ${lectura[2]}</p><p><strong>Dato 3:</strong> ${lectura[3]}</p>`);
      if (revision) html += renderCard("Revisiones SCR", `<pre>${revision[1]}</pre>`);
  }
  document.getElementById("resultados").innerHTML = html || renderCard("Sin resultados", "<p>No se encontr√≥ informaci√≥n para el medidor ingresado.</p>");
}

function limpiarConsulta() {
  document.getElementById("numeroUsuario").value = "";
  document.getElementById("resultados").innerHTML = "";
  document.getElementById("numeroConsultado").innerHTML = "";
}
</script>
</body></html>
