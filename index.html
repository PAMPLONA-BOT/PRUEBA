<!DOCTYPE html>
<html lang="es">
<head>
  <link href="manifest.json" rel="manifest"/>
  <meta name="theme-color" content="#00796b"/>
  <style>
  html, body {
    height: auto !important;
    min-height: 100% !important;
    overflow-y: auto !important;
  }
  </style>

  <style>
    .card pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-x: auto;
      font-size: 15px;
      color: #444;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
  </style>

<html lang="es"><head><link href="manifest.json" rel="manifest"/><meta content="#00796b" name="theme-color"/><script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(reg => console.log('SW registrado:', reg.scope))
    .catch(err => console.error('Error al registrar SW:', err));
}
</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Aplicación de Navegación</title>
<style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      flex-direction: column;
      color: #333;
    }

    .container {
      width: 90%;
      max-width: 600px;
      background-color: #fff;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 0 auto 60px auto;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .container:hover {
      transform: scale(1.02);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    .btn {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .btn:hover {
      background-color: #45a049;
      transform: translateY(-3px);
    }

    .btn-regresar {
      background-color: #FF6347;
      width: 50%;
      margin: 10px auto;
    }

    .btn-regresar:hover {
      background-color: #FF4500;
      transform: translateY(-3px);
    }

    h1 {
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }

    .logo {
      width: 120px;
      height: auto;
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    label {
      font-weight: bold;
      color: #444;
      margin-bottom: 6px;
      text-align: left;
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
      width: 100%;
    }

    .form-group select,
    .form-group input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      border: 2px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }

    #cicloSeccion {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    #cicloSeccion .form-group {
      flex: 1;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      gap: 5px;
      margin-bottom: 20px;
    }

    .btn-row .btn {
      width: 48%;
    }

    #vistaReporte h2 {
      font-size: 30px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2E8B57;
      text-align: center;
    }

    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      text-align: center;
      font-size: 14px;
      color: #888;
      background-color: #fff;
      padding: 10px 0;
      box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
    }

    .footer p {
      margin: 0;
    }

    #whatsappLink {
      text-decoration: none;
      text-align: center;
    }
  </style>
<style>
.card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    padding: 25px;
    margin: 20px auto;
    width: 90%;
    max-width: 800px;
}
.card h3 {
    font-size: 22px;
    margin-bottom: 12px;
    color: #2d7b5f;
}
.card p {
    font-size: 18px;
    color: #333;
    line-height: 1.5;
}
header {
    background: linear-gradient(to right, #00796b, #004d40);
    color: white;
    padding: 20px;
    font-size: 28px;
    font-weight: bold;
    text-align: center;
    border-bottom: 4px solid #004d40;
}
input[type="tel"] {
    border: 2px solid #4caf50;
    border-radius: 10px;
    padding: 15px;
    font-size: 20px;
    width: 80%;
    max-width: 500px;
    margin-bottom: 20px;
}
.numero-consultado {
    color: #00695c;
    font-size: 20px;
    margin: 15px 0;
    text-align: center;
}
button.button {
    transition: all 0.3s ease;
}
</style><style>
@media (max-width: 768px) {
    input[type="tel"] {
        width: 95% !important;
    }
    .card {
        width: 95% !important;
        padding: 15px !important;
    }
    .numero-consultado {
        font-size: 18px !important;
    }
}
form, .card {
    display: flex;
    flex-direction: column;
    align-items: center;
}
form button {
    margin: 10px 0;
}
</style><style>
button.button.green {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 18px;
    margin: 10px;
}
button.button.green:hover {
    background-color: #218838;
}
button.button.blue {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 18px;
    margin: 10px;
}
button.button.blue:hover {
    background-color: #0056b3;
}
button.btn-clear {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 18px;
    margin: 10px;
}
button.btn-clear:hover {
    background-color: #c82333;
}
</style><style>
body {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 30px 10px;
    background-color: #f4f6f8;
    box-sizing: border-box;
}

#interfazSecundaria > div {
    width: 100%;
    max-width: 800px;
    margin: auto;
}
</style><style>
#resultados .card {
    text-align: left;
    padding: 20px;
    word-wrap: break-word;
    box-sizing: border-box;
    margin: 20px auto;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    width: 100%;
    max-width: 800px;
}
#resultados .card p {
    font-size: 16px;
    line-height: 1.6;
    color: #333;
    margin: 8px 0;
}

/* --- ESTILOS PARA EL HISTORIAL DE REPORTES --- */
#reporteHistorico {
  text-align: left;
  margin-top: 25px;
  border-top: 1px solid #eee;
  padding-top: 15px;
}
#reporteHistorico h3 {
  text-align: center;
  color: #333;
}
#listaHistorico {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
}
.item-historico {
  background-color: #f9f9f9;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 8px;
}
.item-historico-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.status-synced {
  color: #28a745;
  font-weight: bold;
}
.status-pending_sync {
  color: #ffc107;
  font-weight: bold;
}
.item-historico details {
  margin-top: 8px;
}
#forceSyncBtn {
  background-color: #ff9800;
  width: 100%;
}
</style>
<style>
.card pre {
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-x: auto;
  font-size: 15px;
  color: #444;
  background-color: #f9f9f9;
  padding: 10px;
  border-radius: 6px;
  width: 100%;
  box-sizing: border-box;
}
</style>
</style><script>
document.addEventListener("DOMContentLoaded", function () {
  const app = document.getElementById('interfazPrincipal');
  const secundaria = document.getElementById('interfazSecundaria');
  if (app) app.style.display = 'none';
  if (secundaria) secundaria.style.display = 'none';

  const esIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const esAndroid = /android/i.test(navigator.userAgent);

  const mensaje = document.getElementById("mensajeInstruccion");
  if (esIOS) {
    mensaje.innerHTML = "<p>📱 En iPhone, toca el botón <strong>Compartir</strong> y elige <strong>'Agregar a pantalla de inicio'</strong>.</p>";
  } else if (esAndroid) {
    mensaje.innerHTML = "<p>📱 En Android, abre el menú del navegador y selecciona <strong>'Agregar a pantalla principal'</strong>.</p>";
  } else {
    mensaje.innerHTML = "<p>Esta aplicación solo funciona correctamente cuando es instalada en la pantalla de inicio.</p>";
  }

  verificarInstalacion(); // por si ya está instalada
});

function verificarInstalacion() {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isStandalone) {
    document.getElementById('pantallaInicio').style.display = 'none';
    const app = document.getElementById('interfazPrincipal');
    const secundaria = document.getElementById('interfazSecundaria');
    if (app) app.style.display = 'block';
  }
}
</script></head><body>
<div id="loginContainer" style="text-align:center;padding:40px;font-family:sans-serif;">
<h2>🔐 Acceso a la App Regional Pamplona</h2>
<p>Ingrese su clave para continuar:</p>
<input id="claveUsuario" placeholder="Clave de acceso" style="padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc; width:80%; max-width:300px;" type="password"/>
<br/><br/>
<button onclick="verificarClave()" style="padding:10px 20px; font-size:16px; border-radius:8px; background-color:#00796b; color:white; border:none;">Ingresar</button>
<p id="mensajeLogin" style="color:red; margin-top:20px;"></p>
</div>
<div id="pantallaInicio" style="text-align:center;padding:40px;font-family:sans-serif;">
<h2>🚀 ¡Bienvenido a la App Regional Pamplona!</h2>
<p>Para usar esta aplicación correctamente, debes instalarla en la pantalla de inicio.</p>
<div id="mensajeInstruccion" style="margin:20px 0;"></div>
<button onclick="verificarInstalacion()" style="padding:10px 20px; font-size:16px; border-radius:8px; background-color:#00796b; color:white; border:none;">Ya la instalé</button>
</div>
<div id="interfazPrincipal" style="display: block;"><!-- Vista principal --><div class="container" id="inicio">
<img alt="Logo de la página" class="logo" src="Logo.png"/>
<h1>REGIONAL PAMPLONA</h1>
<button class="btn" onclick="mostrarFormulario()">REPORTE DIARIO</button>
<button class="btn" onclick="mostrarInterfazSecundaria()">VALIDADOR USUARIOS</button>
<button class="btn" onclick="irAUrl('https://script.google.com/macros/s/AKfycbw2z6rVlBqlPU0drL9Rus_p_ORjVfl8iGQBL-gupoDio4Fq3ElbrqUILguiAtLYWpJZfg/exec', 'revisionEjecutada')">REVISIONES EJECUTADAS</button>
<button class="btn" onclick="irAUrl('https://pamplona-bot.github.io/FIRMAS/', 'FIRMAS')">FIRMA FORMACIONES</button>
<button class="btn" onclick="irAUrl('https://script.google.com/macros/s/AKfycbw-YQTef8VFk4KPc7S8iPnmMXxzaXLegyH8tLk-TqxNwROMi-mRqiUh8LwhQ2J1RbXFAA/exec', 'pendienteDescargas')">CONSULTA DE RUTA Y KML</button>
<!--<button class="btn" onclick="irAUrl('https://script.google.com/macros/s/AKfycbyWqjGdR0kdTvBTiYMDZ0o14nSVOA8opZum-2goxP0gr9oztae9YTPGvxrx4c-ol7Es/exec', 'paginaPrueba')">PENDIENTE POR DESCARGAR</button>-->
<button class="btn" onclick="irAUrl('https://pamplona-bot.github.io/PAMPLONA_ENRUTES/', 'enrutes')">ENRUTES</button>
</div><!-- Vista de formulario --><div class="container hidden" id="vistaReporte">
<h2>Reporte Diario</h2>
<div class="form-group">
<label for="operario">Operario:</label>
<select id="operario"></select>
</div>
<div id="cicloSeccion">
<div class="form-group">
<label for="ciclo">Ciclo:</label>
<select id="ciclo"></select>
</div>
<div class="form-group">
<label for="seccion">Sección:</label>
<select id="seccion"></select>
</div>
</div>
<div class="form-group">
<label for="via">📝 Seleccione tipo de campo:</label>
<select onchange="document.querySelector('label[for=via]').textContent = this.value + ':';">
<option value="🛣️ Vía">🛣️ Vía</option>
<option value="👨🏻 Primer usuario">👨🏻 Primer usuario</option>
<option value="🏙 En">🏙 En</option>
</select>
<input id="via" placeholder="Ingrese dato segun reporte, la vía de traslado, primer usuario o lugar de finalizacion" type="text"/>
</div>
<div class="btn-row">
<button class="btn" onclick="enviarReporte('salida')">TRASLADO SALIDA</button>
<button class="btn" onclick="enviarReporte('regreso')">TRASLADO REGRESO</button>
</div>
<div class="btn-row">
<button class="btn" onclick="enviarReporte('inicio')">INICIO DE LABOR</button>
<button class="btn" onclick="enviarReporte('fin')">FIN DE LABOR</button>
</div>
<button class="btn btn-regresar" onclick="regresarAPrincipal()">INICIO</button>
<a class="btn hidden" href="#" id="whatsappLink" target="_blank">ENVIAR AL GRUPO DE WHATSAPP</a>
<button class="btn" onclick="copiarReporte()">📋 PEGAR REPORTE</button>

<!-- INICIO: SECCIÓN DE HISTORIAL Y SINCRONIZACIÓN -->
<div id="reporteHistorico">
    <h3>Historial de Reportes Diarios</h3>
    <div class="form-group">
        <label for="mesHistorico">Filtrar por Mes:</label>
        <select id="mesHistorico" onchange="renderReportHistory()"></select>
    </div>
    <div id="listaHistorico">No hay reportes guardados.</div>
</div>
<button class="btn" id="forceSyncBtn" onclick="forceSyncPending()" style="display: none; margin-top: 15px;">⚠️ FORZAR ENVÍO DE PENDIENTES</button>
<!-- FIN: SECCIÓN DE HISTORIAL Y SINCRONIZACIÓN -->

</div><div class="footer">
<p>Versión: 001</p>
<p id="fechaHora"></p>
</div>
<!-- ================================================================= -->
<!-- ========= INICIO DEL BLOQUE DE SCRIPT MODIFICADO ========= -->
<!-- ================================================================= -->
<script>
  // --- CONSTANTES Y CONFIGURACIÓN ---
  const REPORTS_STORAGE_KEY = 'daily_reports_pamplona';
  const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxhL9z2Ja7I0QFHn3nReY2NVR1AIn1_SJtei9FIifBLI7vy8PWz0cv_6Dr1Y61z9blcJA/exec';

  // Carga los datos desde los archivos JSON al iniciar la página.
  window.onload = function () {
    mostrarFechaHora();
    setupHistory();

    // Usamos Promise.all para cargar todos los archivos JSON a la vez.
    Promise.all([
      fetch('operarios.json').then(response => response.json()),
      fetch('ciclos.json').then(response => response.json()),
      fetch('secciones.json').then(response => response.json())
    ])
    .then(([operarios, ciclos, seccionesPorCiclo]) => {
      llenarSelect("operario", operarios);
      llenarSelect("ciclo", ciclos);

      document.getElementById("ciclo").addEventListener("change", function () {
        const cicloSeleccionado = this.value;
        const secciones = seccionesPorCiclo[cicloSeleccionado] || [];
        llenarSelect("seccion", secciones);
      });
    })
    .catch(error => {
      console.error("Error al cargar los datos de configuración:", error);
      alert("No se pudieron cargar los datos para el reporte diario. Por favor, revise la conexión y recargue la página.");
    });
  };

  // --- FUNCIONES DE MANEJO DE DATOS LOCALES ---
  function getReports() {
    return JSON.parse(localStorage.getItem(REPORTS_STORAGE_KEY)) || [];
  }

  function saveReports(reports) {
    localStorage.setItem(REPORTS_STORAGE_KEY, JSON.stringify(reports));
    renderReportHistory();
    updateSyncButtonVisibility();
  }

  // --- FUNCIONES DE LA INTERFAZ DE USUARIO (UI) ---
  function llenarSelect(id, valores) {
    const select = document.getElementById(id);
    select.innerHTML = '<option value="">Seleccione</option>';
    valores.forEach(valor => {
      const option = document.createElement("option");
      option.value = valor;
      option.textContent = valor;
      select.appendChild(option);
    });
  }

  function irAUrl(url, boton) {
    if (boton === 'validarUsuario') {
      window.open(url, '_blank');
    } else {
      localStorage.setItem('lastVisited', url);
      window.location.href = url;
    }
  }

  function mostrarFechaHora() {
    const now = new Date();
    const fecha = now.toLocaleDateString();
    const hora = now.toLocaleTimeString();
    document.getElementById('fechaHora').innerHTML = `Fecha y Hora: ${fecha} ${hora}`;
  }

  function mostrarFormulario() {
    document.getElementById('inicio').classList.add('hidden');
    document.getElementById('vistaReporte').classList.remove('hidden');
    renderReportHistory();
    updateSyncButtonVisibility();
  }

  function regresarAPrincipal() {
    document.getElementById('vistaReporte').classList.add('hidden');
    document.getElementById('inicio').classList.remove('hidden');
  }

  // --- LÓGICA PRINCIPAL DE REPORTES ---
  async function guardarEstadoReporte(tipo, operario, ciclo, seccion) {
      const reports = getReports();
      const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
      const reportId = `${new Date().toISOString().slice(0, 10)}-${operario}`;
      const hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

      let report = reports.find(r => r.id === reportId);

      if (!report) {
          if (tipo !== 'salida') {
              alert('Debe iniciar con "TRASLADO SALIDA" para crear el reporte del día.');
              return;
          }
          report = {
              id: reportId,
              operario: operario,
              fechaSalida: today,
              status: 'in_progress'
          };
          reports.push(report);
      }

      switch(tipo) {
          case 'salida':
              report.ciclo = ciclo;
              report.seccion = seccion;
              report.horaSalida = hora;
              break;
          case 'inicio':
              report.horaInicio = hora;
              break;
          case 'regreso':
              report.horaRegreso = hora;
              break;
          case 'fin':
              report.horaFin = hora;
              report.status = 'pending_sync';
              break;
      }

      saveReports(reports);
      
      if (tipo === 'fin') {
          await submitReportToGoogleSheets(report);
      }
  }
  
  // =================================================================
  // FUNCIÓN CORREGIDA FINAL - USANDO FORMDATA (MÉTODO PROBADO)
  // =================================================================
  async function submitReportToGoogleSheets(report) {
    const formData = new FormData();
    formData.append('operario', report.operario || '');
    formData.append('ciclo', report.ciclo || '');
    formData.append('seccion', report.seccion || '');
    formData.append('fechaSalida', report.fechaSalida || '');
    formData.append('horaSalida', report.horaSalida || '');
    formData.append('horaInicio', report.horaInicio || '');
    formData.append('horaRegreso', report.horaRegreso || '');
    formData.append('horaFin', report.horaFin || '');

    try {
        const response = await fetch(GOOGLE_SHEET_URL, {
            method: 'POST',
            body: formData,
            // No es necesario especificar 'headers' cuando se usa FormData,
            // el navegador lo hace automáticamente.
        });

        // Solo si la respuesta es OK (2xx), la procesamos.
        if (!response.ok) {
           throw new Error(`Respuesta del servidor no fue OK: ${response.status} ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.status === 'success') {
            const reports = getReports();
            const reportIndex = reports.findIndex(r => r.id === report.id);
            if (reportIndex > -1) {
                reports[reportIndex].status = 'synced';
                saveReports(reports);
                console.log('Reporte sincronizado con éxito:', report.id);
                alert('Reporte del día finalizado y enviado correctamente.');
            }
        } else {
            throw new Error(result.message || 'El script de Google devolvió un error.');
        }
    } catch (error) {
        console.error('Error al enviar el reporte a Google Sheets:', error);
        alert('No se pudo enviar el reporte. Quedó guardado como pendiente. Podrás forzar el envío más tarde.');
    }
  }

  async function forceSyncPending() {
      const reports = getReports();
      const pendingReports = reports.filter(r => r.status === 'pending_sync');
      
      if (pendingReports.length === 0) {
          alert("No hay reportes pendientes para enviar.");
          return;
      }

      alert(`Iniciando envío de ${pendingReports.length} reporte(s) pendiente(s).`);
      let successCount = 0;

      for (const report of pendingReports) {
          await submitReportToGoogleSheets(report);
          const updatedReports = getReports();
          const syncedReport = updatedReports.find(r => r.id === report.id);
          if(syncedReport && syncedReport.status === 'synced') {
              successCount++;
          }
      }

      alert(`${successCount} de ${pendingReports.length} reporte(s) fueron enviados con éxito.`);
      renderReportHistory();
      updateSyncButtonVisibility();
  }


  function enviarReporte(tipo) {
    const operario = document.getElementById("operario").value;
    const ciclo = document.getElementById("ciclo").value;
    const seccion = document.getElementById("seccion").value;
    const via = document.getElementById("via").value.trim();

    if ((tipo === "salida" || tipo === "regreso") && (!operario || !ciclo || !seccion || !via)) {
      alert("Por favor complete los campos: Operario, Ciclo, Sección y Vía.");
      return;
    }

    if ((tipo === "inicio" || tipo === "fin") && (!operario || !via)) {
      alert("Por favor complete los campos: Operario y Vía.");
      return;
    }

    if (!navigator.geolocation) {
      alert("Tu navegador no permite geolocalización.");
      return;
    }

    navigator.geolocation.getCurrentPosition(async pos => {
      const mapaCod = {
        "0": "F", "1": "G", "2": "C", "3": "I", "4": "V",
        "5": "A", "6": "B", "7": "H", "8": "Z", "9": "J",
        ".": "K", ",": "L", "-": "M"
      };
      const codificarCoord = c => [...c].map(l => mapaCod[l] || '').join('');
      const lat = pos.coords.latitude.toFixed(7);
      const lon = pos.coords.longitude.toFixed(7);
      const codificado = codificarCoord(lat + "," + lon);

      const fecha = new Date().toLocaleDateString();
      const hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      let titulo = "";
      if (tipo === "salida") titulo = "🏍🔀 Traslado de salida";
      if (tipo === "regreso") titulo = "🏍↩️ Traslado de regreso";
      if (tipo === "inicio") titulo = "🧾 Inicio de labor";
      if (tipo === "fin") titulo = "🪫 Fin de labor";

      let mensaje = `${titulo}
🗓 Fecha: ${fecha} ${codificado.slice(0, Math.floor(codificado.length / 2))}
⏰ Hora: ${hora} ${codificado.slice(Math.floor(codificado.length / 2))}
👷‍♂️ Operario: ${operario}`;
      if (tipo === "salida" || tipo === "regreso") {
        mensaje += `
🔁 Ciclo: ${ciclo}
📍 Sección: ${seccion}
🛣️ Vía: ${via}`;
      } else {
        mensaje += `
${document.querySelector("label[for=via]").textContent.replace(":", "")}: ${via}`;
      }

      ultimoMensajeGenerado = mensaje;
      
      await guardarEstadoReporte(tipo, operario, ciclo, seccion);
      
      const url = "https://wa.me/?text=" + encodeURIComponent(mensaje);
      window.open(url, "_blank");

      document.getElementById("via").value = "";
    }, () => {
      alert("Favor activar GPS y DATOS para poder pasar a la aplicacion de WhatsApp");
    });
  }

  // --- FUNCIONES DEL HISTORIAL ---
  let ultimoMensajeGenerado = "";

  function copiarReporte() {
    if (!ultimoMensajeGenerado) {
      alert("No hay reporte disponible para copiar. Por favor genera uno primero.");
      return;
    }
    navigator.clipboard.writeText(ultimoMensajeGenerado).then(() => {
      alert("Reporte copiado al portapapeles. Puedes pegarlo manualmente en WhatsApp.");
    }).catch(() => {
      alert("No se pudo copiar el texto. Intenta manualmente.");
    });
  }
  
  function setupHistory() {
      const reports = getReports();
      const mesSelect = document.getElementById('mesHistorico');
      const meses = [...new Set(reports.map(r => r.id.substring(0, 7)))]; // YYYY-MM
      meses.sort().reverse();
      
      mesSelect.innerHTML = '<option value="">Todos</option>';
      meses.forEach(mes => {
          const option = document.createElement('option');
          option.value = mes;
          const [year, month] = mes.split('-');
          option.textContent = new Date(year, month - 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
          mesSelect.appendChild(option);
      });
  }
  
  function renderReportHistory() {
      setupHistory(); 
      const reports = getReports();
      const listaDiv = document.getElementById('listaHistorico');
      const mesSeleccionado = document.getElementById('mesHistorico').value;
      
      const filteredReports = mesSeleccionado 
          ? reports.filter(r => r.id.startsWith(mesSeleccionado)) 
          : reports;

      filteredReports.sort((a, b) => b.id.localeCompare(a.id));

      if(filteredReports.length === 0){
          listaDiv.innerHTML = "<p>No hay reportes para el mes seleccionado.</p>";
          return;
      }
      
      listaDiv.innerHTML = filteredReports.map(report => `
          <div class="item-historico">
              <div class="item-historico-header">
                  <span><strong>${report.fechaSalida}</strong> - ${report.operario}</span>
                  <span class="status-${report.status}">${report.status === 'synced' ? 'Enviado' : (report.status === 'pending_sync' ? 'Pendiente' : 'En Progreso')}</span>
              </div>
              <details>
                  <summary>Ver detalles</summary>
                  <p><strong>Ciclo-Sección:</strong> ${report.ciclo || 'N/A'} - ${report.seccion || 'N/A'}</p>
                  <p><strong>Salida:</strong> ${report.horaSalida || '--:--'} | <strong>Inicio:</strong> ${report.horaInicio || '--:--'} | <strong>Regreso:</strong> ${report.horaRegreso || '--:--'} | <strong>Fin:</strong> ${report.horaFin || '--:--'}</p>
              </details>
          </div>
      `).join('');
  }

  function updateSyncButtonVisibility() {
      const reports = getReports();
      const hasPending = reports.some(r => r.status === 'pending_sync');
      document.getElementById('forceSyncBtn').style.display = hasPending ? 'block' : 'none';
  }

</script>
<!-- =============================================================== -->
<!-- ========= FIN DEL BLOQUE DE SCRIPT MODIFICADO ========= -->
<!-- =============================================================== -->
<button onclick="actualizarApp()" style="
  display: block;
  margin: 20px auto;
  padding: 10px 20px;
  font-size: 16px;
  background-color: #ffc107;
  color: #000;
  border: none;
  border-radius: 8px;
  cursor: pointer;
">🔁 Actualizar desde servidor App </button><script>
function actualizarApp() {
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
      for (let reg of registrations) {
        reg.unregister().then(() => {
          caches.keys().then(function(names) {
            for (let name of names) caches.delete(name);
          });
          location.reload(true);
        });
      }
    });
  } else {
    location.reload(true);
  }
}
</script></div><div id="interfazSecundaria" style="display: none;"><button onclick="mostrarInterfazPrincipal()" style="
    margin: 20px auto; display: block; background-color: tomato; color: white;
    padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
">⬅ Volver al Inicio</button>
<button onclick="cargarDatosJSON()" style="margin-left:10px; padding:10px 15px; border-radius:8px; background:#0a7d5f; color:white; border:none;">📂 Cargar Datos</button>
<div id="barraCarga" style="margin-top:10px; display:none;">
<progress id="progresoCarga" max="100" style="width:80%; height:20px;" value="0"></progress>
<p id="estadoCarga" style="font-size:14px;"></p>
</div>
<div style="max-width: 800px; margin: auto; padding: 20px; text-align: center;"><header>Consulta de Datos</header><form>
<input id="numeroUsuario" placeholder="Ingrese número de usuario o llave" type="tel"/>
<button class="button green" onclick="buscarDatos()" style="display:none;" type="button">Cliente</button>
<button class="button blue" onclick="buscarDatosConLlave()" style="display:none;" type="button">Medidor</button>
</form><div class="numero-consultado" id="numeroConsultado"></div><div id="resultados"></div><button class="btn-clear button" onclick="limpiarConsulta()" style="display:none;">Limpiar Consulta</button><script>
    
    
    // Validación y limpieza OBLIGATORIA de cache al cambiar de mes
(function() {
    // Función principal de limpieza completa
    async function limpiarCacheCompleto() {
        try {
            // Mostrar overlay de progreso
            const overlay = document.createElement('div');
            overlay.id = 'cache-cleaner-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.95)';
            overlay.style.zIndex = '10000';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.color = 'white';
            overlay.style.padding = '20px';
            overlay.style.textAlign = 'center';
            
            overlay.innerHTML = `
                <h2 style="color: #4CAF50; margin-bottom: 20px;">Actualización Requerida</h2>
                <div style="width: 80%; max-width: 300px; height: 20px; background: #333; border-radius: 10px; margin: 10px 0;">
                    <div id="cleaner-progress-bar" style="width: 0%; height: 100%; background: #4CAF50; border-radius: 10px; transition: width 0.6s;"></div>
                </div>
                <p id="cleaner-progress-text" style="margin-top: 10px; color: #aaa;">Preparando actualización...</p>
            `;
            
            document.body.appendChild(overlay);
            
            // Paso 1: Eliminar Service Workers y caches
            actualizarProgreso('Eliminando datos antiguos...', 20);
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                await Promise.all(registrations.map(reg => reg.unregister()));
                
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
            }
            
            // Paso 2: Limpiar almacenamiento local
            actualizarProgreso('Limpiando configuraciones...', 40);
            localStorage.clear();
            sessionStorage.clear();
            
            // Paso 3: Limpiar IndexedDB
            actualizarProgreso('Actualizando bases de datos...', 60);
            if (window.indexedDB) {
                const dbs = await window.indexedDB.databases();
                await Promise.all(dbs.map(db => {
                    return new Promise((resolve, reject) => {
                        const request = window.indexedDB.deleteDatabase(db.name);
                        request.onsuccess = resolve;
                        request.onerror = reject;
                    });
                }));
            }
            
            // Paso 4: Eliminar cookies del dominio
            actualizarProgreso('Finalizando limpieza...', 80);
            document.cookie.split(';').forEach(cookie => {
                const eqPos = cookie.indexOf('=');
                const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=.pamplona-bot.github.io`;
            });
            
            // Actualizar mes/año en localStorage
            const fecha = new Date();
            localStorage.setItem('ultimoMesUsado', fecha.getMonth() + 1);
            localStorage.setItem('ultimoAnioUsado', fecha.getFullYear());
            
            // Completado - Recargar
            actualizarProgreso('¡Actualización completada!', 100);
            setTimeout(() => {
                window.location.href = window.location.origin + window.location.pathname + '?nocache=' + Date.now();
            }, 1500);
            
            function actualizarProgreso(mensaje, porcentaje) {
                const progressBar = document.getElementById('cleaner-progress-bar');
                const progressText = document.getElementById('cleaner-progress-text');
                
                if (progressBar) progressBar.style.width = `${porcentaje}%`;
                if (progressText) progressText.textContent = mensaje;
            }
            
        } catch (error) {
            console.error('Error en limpieza completa:', error);
            document.getElementById('cache-cleaner-overlay').innerHTML = `
                <h2 style="color: #f44336;">Error en la actualización</h2>
                <p style="color: #ff9800;">La aplicación no puede continuar sin actualizar</p>
                <button onclick="window.location.reload(true)" style="
                    padding: 12px 24px;
                    background: #2196F3;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                    margin-top: 20px;
                ">
                    Recargar manualmente (Ctrl+F5)
                </button>
            `;
        }
    }
    
    // Verificación OBLIGATORIA al cargar
    document.addEventListener("DOMContentLoaded", function() {
        const fechaActual = new Date();
        const mesActual = fechaActual.getMonth() + 1;
        const anioActual = fechaActual.getFullYear();
        
        const ultimoMesUsado = localStorage.getItem('ultimoMesUsado');
        const ultimoAnioUsado = localStorage.getItem('ultimoAnioUsado');
        
        // Si detecta cambio de mes, limpieza OBLIGATORIA
        if (!ultimoMesUsado || (ultimoAnioUsado < anioActual) || 
            (ultimoAnioUsado == anioActual && ultimoMesUsado < mesActual)) {
            
            // Mostrar mensaje de actualización obligatoria
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.95)';
            overlay.style.zIndex = '10000';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.color = 'white';
            overlay.style.padding = '20px';
            overlay.style.textAlign = 'center';
            
            overlay.innerHTML = `
                <div style="background: #222; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                    <h2 style="color: #4CAF50; margin-top: 0;">Actualización Requerida</h2>
                    <p>La aplicación debe actualizarse para el nuevo mes.</p>
                    
                    <div style="background: #333; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <p style="margin: 5px 0;"><strong>Mes anterior:</strong> ${ultimoMesUsado || 'N/A'}/${ultimoAnioUsado || 'N/A'}</p>
                        <p style="margin: 5px 0;"><strong>Mes actual:</strong> ${mesActual}/${anioActual}</p>
                    </div>
                    
                    <p style="color: #FF9800; margin-bottom: 20px;">Se borrarán todos los datos locales para garantizar el correcto funcionamiento.</p>
                    
                    <div id="countdown" style="font-size: 18px; margin: 20px 0;">
                        Iniciando actualización en 5 segundos...
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Cuenta regresiva antes de limpiar automáticamente
            let segundos = 5;
            const countdownElement = document.getElementById('countdown');
            const countdownInterval = setInterval(() => {
                segundos--;
                countdownElement.textContent = `Iniciando actualización en ${segundos} segundos...`;
                
                if (segundos <= 0) {
                    clearInterval(countdownInterval);
                    limpiarCacheCompleto();
                }
            }, 1000);
        } else {
            // Guardar el mes/año actual si no estaba registrado
            localStorage.setItem('ultimoMesUsado', mesActual);
            localStorage.setItem('ultimoAnioUsado', anioActual);
        }
    });
})();

</script></div></div><script>
function mostrarInterfazSecundaria() {
    document.getElementById('interfazPrincipal').style.display = 'none';
    document.getElementById('interfazSecundaria').style.display = 'block';
}
function mostrarInterfazPrincipal() {
    document.getElementById('interfazSecundaria').style.display = 'none';
    document.getElementById('interfazPrincipal').style.display = 'block';
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const mesActual = new Date().getMonth() + 1;
  const anioActual = new Date().getFullYear();
  const claveGuardada = localStorage.getItem("acceso_autorizado");

  if (claveGuardada === mesActual + "-" + anioActual) {
    iniciarFlujoApp();
  } else {
    document.getElementById("pantallaInicio").style.display = "none";
    document.getElementById("interfazPrincipal").style.display = "none";
    document.getElementById("interfazSecundaria").style.display = "none";
  }
});

function verificarClave() {
  const clave = document.getElementById("claveUsuario").value.trim();
  if (!clave) {
    document.getElementById("mensajeLogin").textContent = "Ingrese una clave.";
    return;
  }

  fetch(`https://script.google.com/macros/s/AKfycbxI762q67BzAK-IkJS3Nh8y6qrSCu7YfxPMEvngmO0H8y0sUx89Rj2hjCOe4P22VeNwSA/exec?clave=${clave}`)
    .then(res => res.text())
    .then(respuesta => {
      if (respuesta.trim() === "OK") {
        const mesActual = new Date().getMonth() + 1;
        const anioActual = new Date().getFullYear();
        localStorage.setItem("acceso_autorizado", mesActual + "-" + anioActual);
        iniciarFlujoApp();
      } else {
        document.getElementById("mensajeLogin").textContent = "Clave incorrecta.";
      }
    })
    .catch(() => {
      document.getElementById("mensajeLogin").textContent = "Error al validar. Verifique su conexión.";
    });
}

function iniciarFlujoApp() {
  document.getElementById("loginContainer").style.display = "none";

  const esIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const esAndroid = /android/i.test(navigator.userAgent);

  const mensaje = document.getElementById("mensajeInstruccion");
  if (esIOS) {
    mensaje.innerHTML = "<p>📱 En iPhone, toca el botón <strong>Compartir</strong> y elige <strong>'Agregar a pantalla de inicio'</strong>.</p>";
  } else if (esAndroid) {
    mensaje.innerHTML = "<p>📱 En Android, abre el menú del navegador y selecciona <strong>'Agregar a pantalla principal'</strong>.</p>";
  } else {
    mensaje.innerHTML = "<p>Esta aplicación solo funciona correctamente cuando es instalada en la pantalla de inicio.</p>";
  }

  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isStandalone) {
    document.getElementById("pantallaInicio").style.display = "none";
    document.getElementById("interfazPrincipal").style.display = "block";
  } else {
    document.getElementById("pantallaInicio").style.display = "block";
  }
}
</script>


<script>
let dataUsuarios = [];
let dataLectura = [];
let dataRevisiones = [];
let usuariosCargados = false;
let lecturasCargadas = false;
let revisionesCargadas = false;


function cargarDatosJSON() {
  document.getElementById("barraCarga").style.display = "block";
  document.getElementById("estadoCarga").textContent = "🔄 Iniciando carga de datos...";
  document.getElementById("progresoCarga").value = 0;

  let progreso = 0;

  fetch("https://pamplona-bot.github.io/pamplona-app-pwa/usuarios.json")
    .then(res => {
      progreso = 20;
      document.getElementById("progresoCarga").value = progreso;
      document.getElementById("estadoCarga").textContent = "📂 Cargando usuarios...";
      return res.json();
    })
    .then(data => {
      dataUsuarios = data;
      usuariosCargados = true;
      progreso = 40;
      document.getElementById("progresoCarga").value = progreso;
      document.getElementById("estadoCarga").textContent = "📘 Usuarios cargados. Cargando lecturas...";
      return fetch("https://pamplona-bot.github.io/pamplona-app-pwa/lecturas.json");
    })
    .then(res => {
      progreso = 60;
      document.getElementById("progresoCarga").value = progreso;
      return res.json();
    })
    .then(data => {
      dataLectura = data;
      lecturasCargadas = true;
      document.getElementById("estadoCarga").textContent = "📙 Lecturas cargadas. Cargando revisiones...";
      return fetch("https://pamplona-bot.github.io/pamplona-app-pwa/revisiones.json");
    })
    .then(res => {
      progreso = 80;
      document.getElementById("progresoCarga").value = progreso;
      return res.json();
    })
    .then(data => {
      dataRevisiones = data;
      revisionesCargadas = true;
      progreso = 100;
      document.getElementById("progresoCarga").value = progreso;
      document.getElementById("estadoCarga").textContent = "✅ ¡Todos los datos cargados correctamente!";
      document.querySelector('button[onclick="buscarDatos()"]').style.display = "inline-block";
      document.querySelector('button[onclick="buscarDatosConLlave()"]').style.display = "inline-block";
      document.querySelector('button[onclick="limpiarConsulta()"]').style.display = "inline-block";
    })
    .catch(err => {
      console.error("Error al cargar los archivos JSON", err);
      document.getElementById("estadoCarga").textContent = "❌ Error al cargar datos. Revisa la conexión o el nombre.";
    });
}


function buscarDatos() {
  if (!usuariosCargados || !lecturasCargadas || !revisionesCargadas) {
    alert("Primero debes cargar los datos.");
    return;
  }

  const numero = document.getElementById("numeroUsuario").value.trim();
  let html = "";

  document.getElementById("numeroConsultado").innerHTML = `<strong>CLIENTE CONSULTADO:</strong> ${numero}`;

  const usuario = dataUsuarios.find(row => row[0] === numero);
  const lectura = dataLectura.find(row => row[0] === numero);
  const revision = dataRevisiones.find(row => row[0] === numero);

  if (usuario) {
    html += `<div class="card">
      <h3>Información del Usuario</h3>
      <p><strong>Ciclo:</strong> ${usuario[1]}</p>
      <p><strong>Medidor:</strong> ${usuario[2]}</p>
      <p><strong>Nombre:</strong> ${usuario[3]}</p>
      <p><strong>Dirección:</strong> ${usuario[4]}</p>
      <p><strong>Teléfono:</strong> ${usuario[5]}</p>
      <p><strong>GPS:</strong> <a href="${usuario[6]}" target="_blank">Ver en mapa</a></p>
    </div>`;
  }

  if (lectura) {
    html += `<div class="card">
      <h3>Lecturas</h3>
      <p><strong>Dato 1:</strong> ${lectura[1]}</p>
      <p><strong>Dato 2:</strong> ${lectura[2]}</p>
      <p><strong>Dato 3:</strong> ${lectura[3]}</p>
    </div>`;
  }

  if (revision) {
    html += `<div class="card">
      <h3>Revisiones</h3>
      <pre>${revision[1]}</pre>
    </div>`;
  }

  if (!usuario && !lectura && !revision) {
    html = `<div class="card"><p>No se encontró información para el número ingresado.</p></div>`;
  }

  document.getElementById("resultados").innerHTML = html;
}


function buscarDatosConLlave() {
  if (!usuariosCargados || !lecturasCargadas || !revisionesCargadas) {
    alert("Primero debes cargar los datos.");
    return;
  }

  const llave = document.getElementById("numeroUsuario").value.trim();
  let html = "";

  document.getElementById("numeroConsultado").innerHTML = `<strong>MEDIDOR CONSULTADO:</strong> ${llave}`;

  const usuario = dataUsuarios.find(row => row[7] === llave);
  const lectura = dataLectura.find(row => row[4] === llave);
  const revision = dataRevisiones.find(row => row[1] === llave);

  if (usuario) {
    html += `<p><strong>Cliente:</strong> ${usuario[0]}</p>`;
    html += `<div class="card">
      <h3>Información del Usuario</h3>
      <p><strong>Ciclo:</strong> ${usuario[1]}</p>
      <p><strong>Medidor:</strong> ${usuario[2]}</p>
      <p><strong>Nombre:</strong> ${usuario[3]}</p>
      <p><strong>Dirección:</strong> ${usuario[4]}</p>
      <p><strong>Teléfono:</strong> ${usuario[5]}</p>
      <p><strong>GPS:</strong> <a href="${usuario[6]}" target="_blank">Ver en mapa</a></p>
    </div>`;
  }

  if (lectura) {
    html += `<div class="card">
      <h3>Lecturas</h3>
      <p><strong>Dato 1:</strong> ${lectura[1]}</p>
      <p><strong>Dato 2:</strong> ${lectura[2]}</p>
      <p><strong>Dato 3:</strong> ${lectura[3]}</p>
    </div>`;
  }

  if (revision) {
    html += `<div class="card">
      <h3>Revisiones SCR</h3>
      <pre>${revision[1]}</pre>
    </div>`;
  }

  if (!usuario && !lectura && !revision) {
    html = `<div class="card"><p>No se encontró información para el número ingresado.</p></div>`;
  }

  document.getElementById("resultados").innerHTML = html;
}


function limpiarConsulta() {
  document.getElementById("numeroUsuario").value = "";
  document.getElementById("resultados").innerHTML = "";
  document.getElementById("numeroConsultado").innerHTML = "";
}
</script>
</body></html>
